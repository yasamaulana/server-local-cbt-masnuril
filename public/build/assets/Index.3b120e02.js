import{u as y,a as u,o as k,c as v,b as p,w as m,d as i,t as b,f as A,s as M,L as P,i as f}from"./app.8bde5e17.js";import{L}from"./Student.8552d821.js";import{L as e}from"./leaflet.85e3e899.js";import{a as g}from"./index.d30004a7.js";import{S as l}from"./sweetalert2.all.9e63d2cf.js";import{_ as T}from"./_plugin-vue_export-helper.cdc0426e.js";const I=y({name:"AbsensiSiswa",components:{Link:P},layout:L,props:{auth:{type:Object,required:!0}},data(){return{latitude:-6.901971,longitude:109.504981,map:null,status:"hadir",allowedRadius:150,centerLat:-6.901971,centerLng:109.504981,hasAbsensiToday:!1}},mounted(){this.checkAbsensiToday(),this.initMap(),this.getPositionFirst()},methods:{async getPositionFirst(){try{const t=await this.getCurrentPosition();this.getPosition(t)}catch(t){this.showError(t)}},getPosition(t){this.latitude=t.coords.latitude,this.longitude=t.coords.longitude,this.updateMap()},async checkAbsensiToday(){try{const t=await g.get("/student/check-absensi-today");this.hasAbsensiToday=t.data.hasAbsensiToday}catch(t){console.error(t)}},async getLocation(){try{const t=await this.getCurrentPosition();this.showPosition(t)}catch(t){this.showError(t)}},showPosition(t){this.latitude=t.coords.latitude,this.longitude=t.coords.longitude;const s=this.calculateDistance(this.latitude,this.longitude,this.centerLat,this.centerLng);this.status==="hadir"&&s>this.allowedRadius?l.fire({icon:"warning",title:"Peringatan",text:"Anda berada di luar radius yang diizinkan untuk status 'hadir'."}):(this.updateMap(),this.absenMasuk())},getCurrentPosition(){return new Promise((t,s)=>{navigator.geolocation.getCurrentPosition(t,s)})},showError(t){let s="An unknown error occurred.";switch(t.code){case t.PERMISSION_DENIED:s="User denied the request for Geolocation.";break;case t.POSITION_UNAVAILABLE:s="Location information is unavailable.";break;case t.TIMEOUT:s="The request to get user location timed out.";break}l.fire({icon:"error",title:"Error",text:s})},initMap(){this.map&&this.map.remove(),this.map=e.map("map").setView([this.latitude,this.longitude],20),e.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"\xA9 Innovart Development"}).addTo(this.map);const t=e.divIcon({html:`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-geo-alt-fill" viewBox="0 0 16 16">
                        <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10m0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6"/>
                        </svg>`,className:"text-warning",iconSize:[24,24],iconAnchor:[12,24],popupAnchor:[0,-24]});e.marker([this.latitude,this.longitude],{icon:t}).addTo(this.map).bindPopup("Your current location").openPopup(),e.circle([this.centerLat,this.centerLng],{color:"red",fillColor:"#f03",fillOpacity:.5,radius:this.allowedRadius}).addTo(this.map).bindPopup("Allowed radius"),e.circle([this.latitude,this.longitude],{color:"blue",fillColor:"#30f",fillOpacity:.5,radius:10}).addTo(this.map).bindPopup("Your current location")},updateMap(){if(!this.map){this.initMap();return}this.map.setView([this.latitude,this.longitude],20),this.map.eachLayer(s=>{(s instanceof e.Marker||s instanceof e.Circle)&&this.map.removeLayer(s)});const t=e.divIcon({html:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map-pin"><path d="M21 10c0 6-9 13-9 13S3 16 3 10a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>',className:"",iconSize:[24,24],iconAnchor:[12,24],popupAnchor:[0,-24]});e.marker([this.latitude,this.longitude],{icon:t}).addTo(this.map).bindPopup("Your current location").openPopup(),e.circle([this.centerLat,this.centerLng],{color:"red",fillColor:"#f03",fillOpacity:.5,radius:this.allowedRadius}).addTo(this.map).bindPopup("Allowed radius"),e.circle([this.latitude,this.longitude],{color:"blue",fillColor:"#30f",fillOpacity:.5,radius:100}).addTo(this.map).bindPopup("Your current location")},calculateDistance(t,s,n,d){const c=t*Math.PI/180,r=n*Math.PI/180,a=(n-t)*Math.PI/180,o=(d-s)*Math.PI/180,h=Math.sin(a/2)*Math.sin(a/2)+Math.cos(c)*Math.cos(r)*Math.sin(o/2)*Math.sin(o/2),_=2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));return 6371e3*_},absenMasuk(){g.post("/student/presence-submit",{latitude:this.latitude,longitude:this.longitude,status:this.status}).then(t=>{l.fire({icon:"success",title:"Absen Berhasil",text:t.data.message}).then(()=>{this.resetData()})}).catch(t=>{console.error(t),alert("Failed to submit attendance.")})},resetData(){this.status="hadir",this.hasAbsensiToday=!0,this.checkAbsensiToday()}}}),S=i("title",null,"Absensi Siswa - Aplikasi Ujian Online",-1),C=i("i",{class:"fa fa-long-arrow-alt-left me-2"},null,-1),x=f(" Kembali"),E={class:"card"},O=i("div",{class:"card-title text-center fw-bold"},[i("h3",{class:"mt-2"},"Absensi Siswa")],-1),D={class:"card-body text-center"},N=i("div",{id:"map",style:{height:"500px","margin-bottom":"20px"}},null,-1),z=f("Klik tombol di bawah ini untuk melakukan absensi atas nama "),B={class:"fw-bold"},R={class:"mb-3"},V=i("label",{for:"status",class:"form-label"},"Status:",-1),q=i("option",{value:"hadir"},"Hadir",-1),F=i("option",{value:"izin"},"Izin",-1),U=i("option",{value:"sakit"},"Sakit",-1),Y=i("option",{value:"alpha"},"Alpha",-1),$=[q,F,U,Y],j=["disabled"];function H(t,s,n,d,w,c){const r=u("Head"),a=u("Link");return k(),v("div",null,[p(r,null,{default:m(()=>[S]),_:1}),p(a,{href:"/student/dashboard",class:"btn btn-md btn-primary border-0 shadow mb-3",type:"button"},{default:m(()=>[C,x]),_:1}),i("div",E,[O,i("div",D,[i("button",{class:"btn btn-primary btn-sm mb-2",onClick:s[0]||(s[0]=(...o)=>t.getPositionFirst&&t.getPositionFirst(...o))},"Lokasi Saya"),N,i("p",null,[z,i("span",B,b(t.auth.student.name),1)]),i("div",R,[V,A(i("select",{id:"status","onUpdate:modelValue":s[1]||(s[1]=o=>t.status=o),class:"form-select"},$,512),[[M,t.status]])]),i("button",{disabled:t.hasAbsensiToday,onClick:s[2]||(s[2]=(...o)=>t.getLocation&&t.getLocation(...o)),class:"btn btn-primary"},b(t.hasAbsensiToday?"Sudah Absen":"Absen Masuk"),9,j)])])])}const tt=T(I,[["render",H]]);export{tt as default};
